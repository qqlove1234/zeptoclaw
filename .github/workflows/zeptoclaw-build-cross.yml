name: ZeptoClaw Static Build (cross)

on:
  workflow_dispatch:
    inputs:
      enable_compaction:
        description: 'Enable context compaction'
        required: false
        default: 'true'
      context_limit:
        description: 'Context limit tokens'
        required: false
        default: '12000'
      threshold:
        description: 'Compaction threshold 0-1'
        required: false
        default: '0.8'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl
          components: rustfmt, clippy

      - name: Install cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Apply fixes
        run: |
          # UTF-8 bug fix
          sed -i 's/format!("{}...", &\&text\[\.\.50\])/let preview: String = text.chars().take(50).collect(); format!("{}...", preview)/' src/channels/telegram.rs
          
          # Enable compaction
          if [[ "${{ inputs.enable_compaction }}" == "true" ]]; then
            sed -i 's/enabled: false/enabled: true/' src/config/types.rs
            sed -i 's/context_limit: 100_000/context_limit: ${{ inputs.context_limit }}/' src/config/types.rs
            sed -i 's/threshold: 0.80/threshold: ${{ inputs.threshold }}/' src/config/types.rs
          fi
          git diff

      - name: Build with cross (musl static)
        run: cross build --release --target x86_64-unknown-linux-musl

      - name: Strip and package
        run: |
          strip target/x86_64-unknown-linux-musl/release/zeptoclaw
          tar -czf zeptoclaw-linux-musl.tar.gz -C target/x86_64-unknown-linux-musl/release zeptoclaw

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zeptoclaw-linux-musl
          path: zeptoclaw-linux-musl.tar.gz
